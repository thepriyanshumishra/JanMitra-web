rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ─── Helper functions ───────────────────────────────────────────
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }

    function hasRole(role) {
      return isAuthenticated() && request.auth.token.role == role;
    }

    function isOfficer() {
      return hasRole('officer') || hasRole('dept_admin') || hasRole('system_admin');
    }

    function isAdmin() {
      return hasRole('dept_admin') || hasRole('system_admin');
    }

    function isSystemAdmin() {
      return hasRole('system_admin');
    }

    // ─── users/{uid} ────────────────────────────────────────────────
    // Read: own doc or admin. Write: own doc only (create profile & update name).
    // Hard deletes via Admin SDK only; client marks doc with deleted:true.
    match /users/{uid} {
      allow read: if isOwner(uid) || isAdmin();
      allow create: if isOwner(uid);            // AuthProvider creates profile on first login
      allow update: if isOwner(uid);            // Profile page: name, fcmToken, deleted flag
      allow delete: if false;                   // Hard deletes via Admin SDK only
    }

    // ─── departments/{deptId} ───────────────────────────────────────
    // Public read. Client writes allowed for system_admin (custom claim).
    match /departments/{deptId} {
      allow read: if true;
      allow write: if isSystemAdmin();          // System admin CRUD via departments page
    }

    // ─── departmentStats/{deptId} ───────────────────────────────────
    // Public read. Writes only from server (cron/Admin SDK).
    match /departmentStats/{deptId} {
      allow read: if true;
      allow write: if false;
    }

    // ─── grievances/{grievanceId} ───────────────────────────────────
    match /grievances/{grievanceId} {
      // Citizens: read own complaints
      // Officers/Admins: read all (department-level filtering in API)
      // Public: read-only if privacyLevel == "public"
      allow read: if
        isOwner(resource.data.citizenId) ||
        isOfficer() ||
        resource.data.privacyLevel == 'public';

      // Citizens can update specific fields on their OWN complaint:
      //   - supportCount / supporterIds (support signal)
      //   - status / slaStatus / reopenCount / updatedAt (reopen)
      //   - feedback (rate resolution)
      // All other writes (create, routing, status from officer) via Admin SDK.
      allow update: if isOwner(resource.data.citizenId);
      allow create, delete: if false;

      // ── Events subcollection (append-only) ───────────────────────
      match /events/{eventId} {
        allow read: if
          isAuthenticated() &&
          (
            isOfficer() ||
            get(/databases/$(database)/documents/grievances/$(grievanceId)).data.citizenId == request.auth.uid
          );
        // Citizens can append reopen/feedback events on their own complaints
        allow create: if
          isAuthenticated() &&
          get(/databases/$(database)/documents/grievances/$(grievanceId)).data.citizenId == request.auth.uid;
        allow update, delete: if false;
      }
    }

    // ─── supportSignals/{signalId} ──────────────────────────────────
    // Citizens can add/remove their own support signal.
    // One per (grievanceId, citizenId) pair — enforced at API level.
    match /supportSignals/{signalId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.citizenId;
      allow delete: if isAuthenticated() && request.auth.uid == resource.data.citizenId;
      allow update: if false;
    }

    // ─── delayExplanations/{explanationId} ─────────────────────────
    // Officers can create. Citizens can read explanations for their complaints.
    match /delayExplanations/{explanationId} {
      allow read: if
        isOwner(
          get(/databases/$(database)/documents/grievances/$(resource.data.grievanceId)).data.citizenId
        ) || isOfficer();
      allow create: if isOfficer();
      allow update, delete: if false;
    }

    // ─── citizenFeedback/{feedbackId} ──────────────────────────────
    // Citizens can create feedback on their own closed complaints.
    // Officers and admins can read all feedback.
    match /citizenFeedback/{feedbackId} {
      allow read: if isOwner(resource.data.citizenId) || isOfficer();
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.citizenId;
      allow update, delete: if false;
    }

  }
}
